# IMusic 后端说明文档

## 一、项目概述

IMusic 后端是一个基于 Spring Boot 3.5.6 构建的 RESTful API 服务，为在线音乐播放系统提供用户管理、歌曲搜索、歌单管理等核心功能。

### 1.1 技术栈

| 技术 | 版本 | 说明 |
|-----|------|-----|
| Java | 17 | 开发语言 |
| Spring Boot | 3.5.6 | 核心框架 |
| Spring Data JPA | - | ORM 框架 |
| Spring Security | - | 安全框架 |
| H2 Database | - | 嵌入式数据库 |
| Maven | 3.6+ | 项目构建工具 |

### 1.2 项目结构

```
imusic-backend/
├── src/main/java/xyz/mywebs/imusic/
│   ├── ImusicApplication.java      # 应用程序入口
│   ├── Config/                     # 配置类
│   │   ├── SecurityConfig.java     # Spring Security 配置
│   │   └── WebConfig.java          # Web 配置（CORS、静态资源）
│   ├── Controller/                 # 控制器层
│   │   ├── UserController.java     # 用户相关接口
│   │   └── SongController.java     # 歌曲相关接口
│   ├── Service/                    # 服务层
│   │   ├── UserService.java        # 用户服务
│   │   ├── SongService.java        # 歌曲服务
│   │   ├── SongListService.java    # 歌单服务
│   │   └── SongListItemsService.java # 歌单项目服务
│   ├── Repository/                 # 数据访问层
│   │   ├── UserRepository.java
│   │   ├── SongRepository.java
│   │   ├── SongListRepository.java
│   │   └── SongListItemsRepository.java
│   ├── Entity/                     # 实体类
│   │   ├── User.java               # 用户实体
│   │   ├── Song.java               # 歌曲实体
│   │   ├── SongList.java           # 歌单实体
│   │   └── SongListItems.java      # 歌单项目实体
│   └── Dto/                        # 数据传输对象
│       ├── ApiResponse.java        # 统一响应格式
│       ├── LoginRequest.java       # 登录请求
│       ├── SongRequest.java        # 歌曲请求
│       └── SongResponse.java       # 歌曲响应
├── src/main/resources/
│   ├── application.properties      # 应用配置
│   ├── music_info.json             # 歌曲信息数据
│   ├── cover/                      # 封面图片目录
│   └── mp3/                        # 音乐文件目录
├── data/                           # H2 数据库文件
└── pom.xml                         # Maven 配置
```

---

## 二、系统架构

### 2.1 三层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Controller 层                          │
│         UserController          SongController              │
│              ↓                        ↓                     │
├─────────────────────────────────────────────────────────────┤
│                       Service 层                            │
│   UserService  SongService  SongListService  SongListItems  │
│              ↓                        ↓                     │
├─────────────────────────────────────────────────────────────┤
│                      Repository 层                          │
│   UserRepository  SongRepository  SongListRepository  ...   │
│              ↓                        ↓                     │
├─────────────────────────────────────────────────────────────┤
│                      Database (H2)                          │
│         users    songs    song_list    song_list_items      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 请求处理流程

```
HTTP Request → Controller → Service → Repository → Database
                   ↓
              ApiResponse
                   ↓
HTTP Response ← JSON 序列化
```

---

## 三、数据库设计

### 3.1 ER 图

```
┌──────────────┐       ┌──────────────┐
│    users     │       │    songs     │
├──────────────┤       ├──────────────┤
│ id (PK)      │       │ id (PK)      │
│ username     │       │ filePath     │
│ password     │       │ coverFilePath│
└──────────────┘       │ title        │
       │               │ artist       │
       │               │ album        │
       │               │ albumArtist  │
       │               │ year         │
       │               │ genre        │
       │               │ trackNumber  │
       │               │ bitrate      │
       │               │ duration     │
       │               └──────────────┘
       │
       ↓
┌──────────────┐       ┌──────────────────┐
│  song_list   │       │ song_list_items  │
├──────────────┤       ├──────────────────┤
│ id (PK)      │       │ id (PK)          │
│ listName     │←──────│ listName         │
│ username     │       │ username         │
└──────────────┘       │ title            │
                       │ albumArtist      │
                       │ album            │
                       └──────────────────┘
```

### 3.2 数据表详细说明

#### users 表（用户表）

| 字段 | 类型 | 约束 | 说明 |
|-----|------|-----|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| username | VARCHAR | NOT NULL, UNIQUE | 用户名 |
| password | VARCHAR | NOT NULL | 密码 |

#### songs 表（歌曲表）

| 字段 | 类型 | 约束 | 说明 |
|-----|------|-----|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| file_path | VARCHAR | NOT NULL | 音频文件路径 |
| cover_file_path | VARCHAR | NOT NULL | 封面图片路径 |
| title | VARCHAR | NOT NULL | 歌曲标题 |
| artist | VARCHAR | NOT NULL | 艺术家 |
| album | VARCHAR | NOT NULL | 专辑名称 |
| album_artist | VARCHAR | NOT NULL | 专辑艺术家 |
| year | VARCHAR | NOT NULL | 发行年份 |
| genre | VARCHAR | NOT NULL | 音乐流派 |
| track_number | VARCHAR | NOT NULL | 曲目编号 |
| bitrate | VARCHAR | NOT NULL | 比特率 |
| duration | VARCHAR | NOT NULL | 时长 |

#### song_list 表（歌单表）

| 字段 | 类型 | 约束 | 说明 |
|-----|------|-----|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| list_name | VARCHAR | NOT NULL | 歌单名称 |
| username | VARCHAR | NOT NULL | 创建用户 |

#### song_list_items 表（歌单项目表）

| 字段 | 类型 | 约束 | 说明 |
|-----|------|-----|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键 |
| title | VARCHAR | NOT NULL | 歌曲标题 |
| album_artist | VARCHAR | NOT NULL | 专辑艺术家 |
| album | VARCHAR | NOT NULL | 专辑名称 |
| username | VARCHAR | NOT NULL | 所属用户 |
| list_name | VARCHAR | NOT NULL | 所属歌单 |

---

## 四、API 接口文档

### 4.1 统一响应格式

所有接口返回统一的 JSON 格式：

```json
{
  "success": true/false,
  "message": {
    "ok": "成功信息",
    "error": "错误信息",
    "songs": [...],
    ...
  }
}
```

### 4.2 用户接口 (UserController)

#### 4.2.1 用户注册

- **URL**: `POST /api/user/register`
- **请求体**:
```json
{
  "username": "用户名",
  "password": "密码"
}
```
- **成功响应**:
```json
{
  "success": true,
  "message": { "ok": "注册成功" }
}
```
- **失败响应**:
```json
{
  "success": false,
  "message": { "error": "用户名已存在" }
}
```

#### 4.2.2 用户登录

- **URL**: `POST /api/user/login/password`
- **请求体**:
```json
{
  "username": "用户名",
  "password": "密码"
}
```
- **成功响应**:
```json
{
  "success": true,
  "message": { "ok": "登录成功" }
}
```
- **说明**: 登录成功后，用户信息存储在 Session 中

#### 4.2.3 获取用户歌单列表

- **URL**: `POST /api/user/songLists/show`
- **请求体**: `{}`
- **成功响应**:
```json
{
  "success": true,
  "message": {
    "songLists": [
      { "id": 1, "listName": "我的收藏", "username": "user1" }
    ]
  }
}
```

#### 4.2.4 创建歌单

- **URL**: `POST /api/user/songLists/add`
- **请求体**:
```json
{
  "listName": "歌单名称"
}
```
- **成功响应**:
```json
{
  "success": true,
  "message": { "ok": "歌单创建成功" }
}
```

### 4.3 歌曲接口 (SongController)

#### 4.3.1 搜索歌曲

- **URL**: `POST /api/song/search/all`
- **请求体**:
```json
{
  "title": "搜索关键词"
}
```
或
```json
{
  "albumArtist": "艺术家名称"
}
```
- **成功响应**:
```json
{
  "success": true,
  "message": {
    "ok": "查询成功",
    "songs": [
      {
        "filePath": "/mp3/song.mp3",
        "coverFilePath": "/cover/cover.jpg",
        "title": "歌曲名",
        "artist": "艺术家",
        "album": "专辑",
        "albumArtist": "专辑艺术家",
        "year": "2024",
        "genre": "Pop",
        "trackNumber": "1",
        "bitrate": "320kbps",
        "duration": "3:45"
      }
    ]
  }
}
```
- **说明**: 搜索结果按匹配度排序

#### 4.3.2 播放歌曲

- **URL**: `POST /api/song/play`
- **请求体**:
```json
{
  "title": "歌曲名",
  "albumArtist": "专辑艺术家",
  "album": "专辑名"
}
```
- **成功响应**:
```json
{
  "success": true,
  "message": {
    "ok": "播放成功",
    "song": { ... }
  }
}
```

#### 4.3.3 查询歌单中的歌曲

- **URL**: `POST /api/song/search/insonglist`
- **请求体**:
```json
{
  "listName": "歌单名称"
}
```
- **成功响应**:
```json
{
  "success": true,
  "message": {
    "ok": "歌单音乐查询成功",
    "songs": [...]
  }
}
```

#### 4.3.4 添加歌曲到歌单

- **URL**: `POST /api/song/add/tosonglist`
- **请求体**:
```json
{
  "title": "歌曲名",
  "albumArtist": "专辑艺术家",
  "album": "专辑名",
  "listName": "歌单名称"
}
```
- **成功响应**:
```json
{
  "success": true,
  "message": { "ok": "歌曲已成功添加到歌单" }
}
```

#### 4.3.5 从歌单删除歌曲

- **URL**: `POST /api/song/delete/fromsonglist`
- **请求体**:
```json
{
  "title": "歌曲名",
  "albumArtist": "专辑艺术家",
  "album": "专辑名",
  "listName": "歌单名称"
}
```
- **成功响应**:
```json
{
  "success": true,
  "message": { "ok": "歌曲已成功从歌单中删除" }
}
```

### 4.4 静态资源接口

| 路径 | 说明 |
|-----|------|
| `/cover/**` | 封面图片资源 |
| `/mp3/**` | 音乐文件资源 |
| `/h2-console` | H2 数据库控制台 |

---

## 五、核心代码说明

### 5.1 配置类

#### SecurityConfig.java

Spring Security 配置，禁用 CSRF 保护，允许所有请求访问：

```java
@Configuration
public class SecurityConfig {
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .cors(cors -> {})
            .authorizeHttpRequests(authorize -> authorize
                .anyRequest().permitAll()
            )
            .csrf(csrf -> csrf.disable())
            .headers(headers -> headers.frameOptions(frameOptions -> frameOptions.disable()));
        return http.build();
    }
}
```

#### WebConfig.java

CORS 跨域配置和静态资源映射：

```java
@Configuration
public class WebConfig {
    @Bean
    public WebMvcConfigurer corsConfigurer() {
        return new WebMvcConfigurer() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**")
                    .allowedOriginPatterns(
                        "https://myweb2025.xyz",
                        "https://imusic.myweb2025.xyz",
                        "https://*.vercel.app",
                        "http://localhost:*"
                    )
                    .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS", "HEAD")
                    .allowedHeaders("*")
                    .allowCredentials(true)
                    .maxAge(3600);
            }

            @Override
            public void addResourceHandlers(ResourceHandlerRegistry registry) {
                registry.addResourceHandler("/cover/**")
                    .addResourceLocations("classpath:/cover/");
                registry.addResourceHandler("/mp3/**")
                    .addResourceLocations("classpath:/mp3/");
            }
        };
    }
}
```

### 5.2 服务层核心逻辑

#### SongService.java - 歌曲搜索与排序

```java
public List<Song> findByAlbumArtistOrTitleWithSorting(String songIdentifier) {
    List<Song> songs = songRepository.findByAlbumArtistOrTitle(songIdentifier);
    // 按匹配度降序排序
    songs.sort((s1, s2) -> {
        int score1 = calculateMatchScore(s1, songIdentifier);
        int score2 = calculateMatchScore(s2, songIdentifier);
        return Integer.compare(score2, score1);
    });
    return songs;
}

private int calculateMatchScore(Song song, String songIdentifier) {
    int score = 0;
    if (song.getTitle().contains(songIdentifier)) score++;
    if (song.getAlbumArtist().contains(songIdentifier)) score++;
    return score;
}
```

#### SongService.java - 启动时自动加载歌曲数据

```java
@PostConstruct
public void init() {
    updateSongsFromJson();  // 启动时从 JSON 文件加载歌曲
}

public void updateSongsFromJson() {
    ClassPathResource resource = new ClassPathResource("music_info.json");
    File jsonFile = resource.getFile();
    List<Song> songs = objectMapper.readValue(jsonFile, ...);
    for (Song song : songs) {
        Song existingSong = songRepository.findByAlbumArtistAndAlbumAndTitle(...);
        if (existingSong == null) {
            songRepository.save(song);
        }
    }
}
```

### 5.3 Repository 层 - 自定义查询

#### SongRepository.java

```java
public interface SongRepository extends JpaRepository<Song, Long> {
    Song findByAlbumArtistAndAlbumAndTitle(String albumArtist, String album, String title);

    @Query("SELECT s FROM Song s WHERE s.title LIKE %:songIdentifier% OR s.albumArtist LIKE %:songIdentifier%")
    List<Song> findByAlbumArtistOrTitle(@Param("songIdentifier") String songIdentifier);
}
```

---

## 六、会话管理

### 6.1 Session 配置

在 `application.properties` 中配置：

```properties
server.servlet.session.cookie.same-site=none
server.servlet.session.cookie.secure=true
server.servlet.session.cookie.http-only=true
server.servlet.session.timeout=300m
```

### 6.2 登录状态验证

登录成功后，将用户信息存入 Session：

```java
session.setAttribute("username", loginRequest.getUsername());
session.setAttribute("password", loginRequest.getPassword());
```

需要登录的接口会验证 Session：

```java
String currentUser = (String) session.getAttribute("username");
if (currentUser == null) {
    responseMessage.put("error", "未登录");
    return new ApiResponse(false, responseMessage);
}
```

---

## 七、部署说明

### 7.1 环境要求

- JDK 17+
- Maven 3.6+

### 7.2 本地运行

```bash
cd imusic-backend
mvn spring-boot:run
```

服务将在 http://localhost:8080 启动

### 7.3 打包部署

```bash
mvn clean package
java -jar target/imusic-0.0.1-SNAPSHOT.jar
```

### 7.4 配置文件说明

`application.properties` 主要配置项：

```properties
# 服务端口
server.port=8080

# H2 数据库配置
spring.datasource.url=jdbc:h2:file:./data/imusic
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

# H2 控制台
spring.h2.console.enabled=true
spring.h2.console.path=/h2-console

# JPA 配置
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
```

---

## 八、接口测试示例

### 8.1 使用 curl 测试

```bash
# 用户注册
curl -X POST http://localhost:8080/api/user/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}'

# 用户登录
curl -X POST http://localhost:8080/api/user/login/password \
  -H "Content-Type: application/json" \
  -c cookies.txt \
  -d '{"username":"test","password":"123456"}'

# 搜索歌曲
curl -X POST http://localhost:8080/api/song/search/all \
  -H "Content-Type: application/json" \
  -d '{"title":"周杰伦"}'

# 添加到收藏（需要登录）
curl -X POST http://localhost:8080/api/song/add/tosonglist \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{"title":"晴天","albumArtist":"周杰伦","album":"叶惠美","listName":"我的收藏"}'
```

---

## 九、依赖说明

`pom.xml` 主要依赖：

```xml
<dependencies>
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- Spring Data JPA -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>

    <!-- Spring Security -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>

    <!-- H2 Database -->
    <dependency>
        <groupId>com.h2database</groupId>
        <artifactId>h2</artifactId>
        <scope>runtime</scope>
    </dependency>

    <!-- MySQL Connector (备用) -->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
        <scope>runtime</scope>
    </dependency>
</dependencies>
```
