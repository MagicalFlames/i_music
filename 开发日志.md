# IMusic 项目开发日志

> 开发周期：2025年12月15日 - 2025年12月20日
>
> 开发者：邬子阳
>
> 项目名称：IMusic 在线音乐播放系统

---

## 2025年12月15日 星期一

### 上午：项目规划与需求分析

**工作内容**：

今天是项目开发的第一天，主要进行项目的整体规划和需求分析。

1. **确定项目目标**

   - 开发一个在线音乐播放系统
   - 支持用户注册登录
   - 支持歌曲搜索和在线播放
   - 支持收藏功能
2. **技术选型讨论**

   - 前端：考虑使用 React，因为其组件化开发模式适合构建复杂的用户界面
   - 后端：选择 Spring Boot，Java 生态成熟，开发效率高
   - 数据库：初期使用 H2 嵌入式数据库，方便开发和测试
3. **绘制系统架构草图**

   - 采用前后端分离架构
   - RESTful API 设计
   - 三层架构：Controller -> Service -> Repository

**遇到的问题**：

- 音乐文件存储方案需要确定：最终决定使用文件系统存储，数据库只保存路径信息

**明日计划**：

- 搭建后端项目基础框架
- 设计数据库表结构

---

### 下午：环境搭建

**工作内容**：

1. **开发环境配置**

   - 安装 JDK 17
   - 配置 Maven 环境
   - 安装 Node.js 18
   - 配置 IDE（IntelliJ IDEA / VS Code）
2. **创建项目目录结构**

   ```
   imusic/
   ├── imusic-backend/
   └── imusic-frontend/
   ```
3. **初始化 Git 仓库**

   ```bash
   git init
   git add .
   git commit -m "first commit"
   ```

---

## 2025年12月16日 星期二

### 上午：后端项目初始化

**工作内容**：

1. **创建 Spring Boot 项目**

   使用 Spring Initializr 创建项目，添加以下依赖：

   - Spring Web
   - Spring Data JPA
   - Spring Security
   - H2 Database
   - MySQL Driver（预留生产环境使用）
2. **编写 pom.xml 配置**

   ```xml
   <parent>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-parent</artifactId>
       <version>3.5.6</version>
   </parent>

   <properties>
       <java.version>17</java.version>
   </properties>
   ```
3. **配置 application.properties**

   ```properties
   spring.application.name=imusic
   server.port=8080
   spring.datasource.url=jdbc:h2:file:./data/imusic
   spring.datasource.driverClassName=org.h2.Driver
   spring.jpa.hibernate.ddl-auto=update
   ```

**遇到的问题**：

- H2 数据库控制台无法访问
- 解决方案：添加 `spring.h2.console.enabled=true` 配置

---

### 下午：数据库设计与实体类开发

**工作内容**：

1. **设计数据库表结构**

   经过分析，确定需要以下4张表：

   - users：用户表
   - songs：歌曲信息表
   - song_list：歌单表
   - song_list_items：歌单项目表
2. **编写 User 实体类**

   ```java
   @Entity
   @Table(name = "users")
   public class User {
       @Id
       @GeneratedValue(strategy = GenerationType.IDENTITY)
       private Long id;

       @Column(nullable = false, unique = true)
       private String username;

       @Column(nullable = false)
       private String password;
   }
   ```
3. **编写 Song 实体类**

   歌曲实体包含丰富的元数据信息：

   - filePath：音频文件路径
   - coverFilePath：封面图片路径
   - title：歌曲标题
   - artist：歌手
   - album：专辑
   - albumArtist：专辑艺术家
   - year：年份
   - genre：流派
   - trackNumber：曲目编号
   - bitrate：比特率
   - duration：时长
4. **编写 SongList 和 SongListItems 实体类**

   用于支持用户创建歌单和收藏功能

**技术笔记**：

- JPA 的 `@Column(name = "\"year\"")` 用于处理 year 作为 SQL 保留字的问题
- 使用 `@GeneratedValue(strategy = GenerationType.IDENTITY)` 实现主键自增

---

## 2025年12月17日 星期三

### 上午：后端 Repository 和 Service 层开发

**工作内容**：

1. **编写 Repository 接口**

   创建4个 Repository 接口：

   ```java
   public interface UserRepository extends JpaRepository<User, Long> {
       User findByUsername(String username);
   }

   public interface SongRepository extends JpaRepository<Song, Long> {
       List<Song> findByTitleContainingOrAlbumArtistContaining(String title, String artist);
   }

   public interface SongListRepository extends JpaRepository<SongList, Long> {
       List<SongList> findByUsername(String username);
   }

   public interface SongListItemsRepository extends JpaRepository<SongListItems, Long> {
       List<SongListItems> findByUsernameAndListName(String username, String listName);
   }
   ```
2. **编写 Service 层**

   - **UserService**：用户注册、登录验证、查询用户
   - **SongService**：歌曲搜索、根据条件查询歌曲
   - **SongListService**：创建歌单、获取用户歌单
   - **SongListItemsService**：添加歌曲到歌单、从歌单删除歌曲、查询歌单内容
3. **实现歌曲搜索排序功能**

   为了提升搜索体验，实现了按相关性排序的搜索功能：

   ```java
   public List<Song> findByAlbumArtistOrTitleWithSorting(String keyword) {
       // 搜索匹配的歌曲并按相关性排序
   }
   ```

**遇到的问题**：

- JPA 自定义查询方法命名太长，可读性差
- 解决方案：使用 `@Query` 注解编写自定义 JPQL 查询

---

### 下午：后端 Controller 层开发

**工作内容**：

1. **编写 UserController**

   实现以下接口：

   | 接口                          | 功能         |
   | ----------------------------- | ------------ |
   | POST /api/user/login/password | 用户登录     |
   | POST /api/user/register       | 用户注册     |
   | POST /api/user/songLists/show | 获取用户歌单 |
   | POST /api/user/songLists/add  | 创建歌单     |
2. **编写 SongController**

   实现以下接口：

   | 接口                               | 功能         |
   | ---------------------------------- | ------------ |
   | POST /api/song/search/all          | 搜索歌曲     |
   | POST /api/song/play                | 播放歌曲     |
   | POST /api/song/search/insonglist   | 查询歌单歌曲 |
   | POST /api/song/add/tosonglist      | 添加到歌单   |
   | POST /api/song/delete/fromsonglist | 从歌单删除   |
3. **设计统一响应格式**

   ```java
   public class ApiResponse {
       private boolean success;
       private Map<String, Object> message;
   }
   ```
4. **实现会话管理**

   使用 HttpSession 管理用户登录状态：

   ```java
   session.setAttribute("username", loginRequest.getUsername());
   session.setAttribute("password", loginRequest.getPassword());
   ```

**技术笔记**：

- 使用 `@RestController` 替代 `@Controller + @ResponseBody`
- 使用 `@RequestMapping` 统一设置路由前缀

---

## 2025年12月18日 星期四

### 上午：后端安全配置与跨域处理

**工作内容**：

1. **配置 Spring Security**

   编写 SecurityConfig.java，配置安全策略：

   ```java
   @Configuration
   public class SecurityConfig {
       @Bean
       public SecurityFilterChain filterChain(HttpSecurity http) {
           http.csrf().disable()
               .authorizeHttpRequests()
               .anyRequest().permitAll();
           return http.build();
       }
   }
   ```
2. **配置 CORS 跨域**

   编写 WebConfig.java，允许前端跨域访问：

   ```java
   @Configuration
   public class WebConfig implements WebMvcConfigurer {
       @Override
       public void addCorsMappings(CorsRegistry registry) {
           registry.addMapping("/**")
                   .allowedOriginPatterns("*")
                   .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                   .allowCredentials(true);
       }
   }
   ```
3. **配置 Cookie 属性**

   为了支持跨域携带 Cookie，配置以下属性：

   ```properties
   server.servlet.session.cookie.same-site=none
   server.servlet.session.cookie.secure=true
   server.servlet.session.cookie.http-only=true
   server.servlet.session.timeout=300m
   ```

**遇到的问题**：

- 前端请求无法携带 Cookie
- 原因分析：Chrome 80+ 版本默认 SameSite=Lax
- 解决方案：设置 SameSite=None 并启用 Secure

---

### 下午：前端项目初始化

**工作内容**：

1. **创建 React 项目**

   ```bash
   cd imusic-frontend
   npm init -y
   npm install react react-dom
   npm install vite @vitejs/plugin-react -D
   ```
2. **配置 Vite**

   创建 vite.config.js：

   ```javascript
   import { defineConfig } from 'vite'
   import react from '@vitejs/plugin-react'

   export default defineConfig({
     plugins: [react()]
   })
   ```
3. **创建基础文件结构**

   ```
   src/
   ├── main.jsx
   ├── App.jsx
   ├── App.css
   ├── index.css
   ├── config.js
   └── components/
   ```
4. **编写配置文件**

   ```javascript
   // config.js
   export const BASE_URL = 'http://localhost:8080'
   ```
5. **设计页面布局**

   - 顶部：标题 + 导航标签 + 登录按钮
   - 中间：搜索区域 / 收藏列表
   - 底部：播放器控制栏

---

## 2025年12月19日 星期五

### 上午：前端核心组件开发

**工作内容**：

1. **开发 SearchBar 组件**

   搜索栏组件，包含输入框和搜索按钮：

   ```jsx
   function SearchBar({ onSearch }) {
     const [query, setQuery] = useState('')

     const handleSubmit = (e) => {
       e.preventDefault()
       onSearch(query)
     }

     return (
       <form onSubmit={handleSubmit}>
         <input value={query} onChange={e => setQuery(e.target.value)} />
         <button type="submit">搜索</button>
       </form>
     )
   }
   ```
2. **开发 SongList 组件**

   歌曲列表组件，展示搜索结果：

   - 显示歌曲封面、标题、艺术家、专辑
   - 支持播放按钮、收藏按钮
   - 高亮显示当前播放歌曲
3. **开发 Player 组件**

   播放器组件，包含：

   - 歌曲封面和信息显示
   - 播放/暂停按钮
   - 上一曲/下一曲按钮
   - 进度条（可拖拽）
   - 音量控制滑块
   - 时间显示
4. **实现音频播放功能**

   ```jsx
   const audioRef = useRef(null)

   useEffect(() => {
     if (audioRef.current && currentSong) {
       audioRef.current.play()
     }
   }, [currentSong])

   <audio
     ref={audioRef}
     src={currentSong?.url}
     onTimeUpdate={handleTimeUpdate}
     onLoadedMetadata={handleLoadedMetadata}
     onEnded={handleEnded}
   />
   ```

**遇到的问题**：

- 进度条拖拽时音频跳动
- 解决方案：拖拽时暂停更新，拖拽结束后设置 currentTime

---

### 下午：前端用户功能开发

**工作内容**：

1. **开发 Login 组件**

   登录/注册弹窗组件：

   - 支持登录和注册两种模式切换
   - 表单验证
   - 错误提示
   - 成功后自动关闭
2. **开发 Favorites 组件**

   收藏列表组件：

   - 展示用户收藏的歌曲
   - 支持播放和取消收藏
   - 空状态提示
3. **开发 Toast 组件**

   全局提示组件：

   ```jsx
   export function showToast(message, type = 'info') {
     // 显示提示消息
     // type: success, error, warning, info
   }
   ```
4. **开发 LoadingOverlay 组件**

   加载遮罩组件，在请求时显示加载状态
5. **实现登录状态持久化**

   ```jsx
   // 登录成功后保存到 LocalStorage
   localStorage.setItem('username', username)
   localStorage.setItem('password', password)
   localStorage.setItem('isLoggedIn', 'true')

   // 页面加载时恢复登录
   useEffect(() => {
     const restoreLogin = async () => {
       const isLoggedIn = localStorage.getItem('isLoggedIn')
       if (isLoggedIn === 'true') {
         // 调用登录接口恢复会话
       }
     }
     restoreLogin()
   }, [])
   ```

---

## 2025年12月20日 星期六

### 上午：前后端联调与测试

**工作内容**：

1. **API 联调测试**

   逐个测试所有接口：

   - [X] 用户注册 `/api/user/register`
   - [X] 用户登录 `/api/user/login/password`
   - [X] 歌曲搜索 `/api/song/search/all`
   - [X] 添加收藏 `/api/song/add/tosonglist`
   - [X] 查询收藏 `/api/song/search/insonglist`
   - [X] 删除收藏 `/api/song/delete/fromsonglist`
2. **修复发现的问题**

   | 问题           | 原因         | 解决方案                                |
   | -------------- | ------------ | --------------------------------------- |
   | 封面图片不显示 | 路径拼接错误 | 检查是否为完整URL，否则添加BASE_URL前缀 |
   | 登录状态丢失   | Cookie未携带 | 添加 credentials: 'include'             |
   | 搜索无结果     | 关键字为空   | 添加空值判断                            |
3. **优化用户体验**

   - 添加加载状态提示
   - 添加操作反馈 Toast
   - 优化错误处理

---

### 下午：样式优化与文档编写

**工作内容**：

1. **CSS 样式优化**

   - 统一配色方案
   - 优化按钮悬停效果
   - 优化播放器样式
   - 添加过渡动画
2. **响应式适配**

   - 适配不同屏幕宽度
   - 优化移动端显示
3. **代码整理**

   - 删除调试代码
   - 添加必要注释
   - 格式化代码
4. **编写项目文档**

   - 系统说明文档
   - 开发日志
5. **提交代码到 GitHub**

   ```bash
   git add .
   git commit -m "完成 IMusic 音乐播放系统开发"
   git remote add origin https://github.com/MagicalFlames/i_music.git
   git push -u origin main
   ```

---

## 开发总结

### 项目完成情况

| 模块          | 状态    | 备注                 |
| ------------- | ------- | -------------------- |
| 用户注册/登录 | ✅ 完成 | 支持持久化登录       |
| 歌曲搜索      | ✅ 完成 | 支持标题和艺术家搜索 |
| 在线播放      | ✅ 完成 | 支持完整播放控制     |
| 收藏管理      | ✅ 完成 | 支持添加和删除       |
| 歌单管理      | ✅ 完成 | 后端已实现           |

### 技术收获

1. **Spring Boot 3.x**

   - 学习了新版 Spring Security 配置方式
   - 掌握了 Spring Data JPA 的使用
   - 了解了 Session 管理和 Cookie 配置
2. **React 19**

   - 学习了 Hooks 的使用（useState, useEffect, useRef）
   - 掌握了组件化开发模式
   - 了解了前端状态管理
3. **前后端分离**

   - 理解了 CORS 跨域原理和解决方案
   - 掌握了 RESTful API 设计
   - 学习了前后端联调技巧

### 待优化项

1. 密码加密存储（使用 BCrypt）
2. 添加 JWT Token 认证
3. 支持更多歌单操作
4. 添加歌词显示功能
5. 支持播放列表和播放模式

### 开发时间统计

| 日期           | 工作内容                             | 耗时          |
| -------------- | ------------------------------------ | ------------- |
| 12月15日       | 项目规划、环境搭建                   | 8h            |
| 12月16日       | 后端初始化、数据库设计               | 8h            |
| 12月17日       | Repository、Service、Controller 开发 | 8h            |
| 12月18日       | 安全配置、前端初始化                 | 8h            |
| 12月19日       | 前端组件开发                         | 8h            |
| 12月20日       | 联调测试、文档编写                   | 6h            |
| **合计** |                                      | **46h** |

---

## 附录：常用命令

### 后端启动

```bash
cd imusic-backend
mvn spring-boot:run
```

### 前端启动

```bash
cd imusic-frontend
npm run dev
```

### 数据库控制台

访问 `http://localhost:8080/h2-console`

- JDBC URL: `jdbc:h2:file:./data/imusic`
- User: `sa`
- Password: （空）

---

*文档编写日期：2025年12月20日*
